version: '3.8'

services:
  # ═══════════════════════════════════════════════════════════════════════════
  # DEPLOYMENT OPTION 1: SEPARATE CONTAINERS (Recommended for Production)
  # ═══════════════════════════════════════════════════════════════════════════

  # ─── The Warden (Supervisor) ──────────────────────────────────────────────
  warden:
    image: clawrden-warden:latest
    container_name: clawrden-warden
    hostname: warden

    # Run only warden service from multi-service image
    command: ["warden"]

    # Mount dependencies
    volumes:
      - ./policy.yaml:/etc/clawrden/policy.yaml:ro

      # Shared socket directory (all prisoners and bridges will mount this)
      - socket-dir:/var/run/clawrden

      # Docker socket (for Mirror/Ghost execution)
      - /var/run/docker.sock:/var/run/docker.sock

      # Audit logs
      - ./logs:/var/log/clawrden

      # Shared workspace
      - workspace:/app

      # Jailhouse directories (warden creates jail dirs here)
      - jailhouse-data:/var/lib/clawrden

    # Warden needs full privileges for Docker operations
    privileged: true

    # Expose API
    ports:
      - "8080:8080"

    # Network
    networks:
      - clawrden

    # Health check
    healthcheck:
      test: ["CMD", "wget", "-q", "-O-", "http://localhost:8080/api/status", "||", "exit", "1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

  # ─── Slack Bridge ─────────────────────────────────────────────────────────
  slack-bridge:
    image: clawrden-warden:latest
    container_name: clawrden-slack-bridge
    hostname: slack-bridge

    # Run only slack service from multi-service image
    command: ["slack"]

    environment:
      - SLACK_BOT_TOKEN=${SLACK_BOT_TOKEN}
      - SLACK_APP_TOKEN=${SLACK_APP_TOKEN}
      - SLACK_SIGNING_SECRET=${SLACK_SIGNING_SECRET}

    networks:
      - clawrden

    depends_on:
      warden:
        condition: service_healthy

  # ─── Telegram Bridge ──────────────────────────────────────────────────────
  telegram-bridge:
    image: clawrden-warden:latest
    container_name: clawrden-telegram-bridge
    hostname: telegram-bridge

    # Run only telegram service from multi-service image
    command: ["telegram"]

    environment:
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}

    networks:
      - clawrden

    depends_on:
      warden:
        condition: service_healthy

  # ═══════════════════════════════════════════════════════════════════════════
  # PRISONERS
  #
  # Each prisoner mounts the jailhouse volume (read-only) and sets PATH to
  # include its jail's bin directory. The jail ID in the PATH must match
  # a jail defined in policy.yaml (e.g., "my-agent" or "python-agent").
  # ═══════════════════════════════════════════════════════════════════════════

  # ─── Prisoner 1 (Ubuntu-based agent) ──────────────────────────────────────
  prisoner1:
    image: clawrden-ubuntu
    container_name: clawrden-prisoner1
    hostname: prisoner1

    # Mount shared volumes
    volumes:
      - jailhouse-data:/var/lib/clawrden:ro  # Jail shim directory (read-only)
      - socket-dir:/var/run/clawrden         # Warden socket
      - workspace:/app                        # Shared workspace

    # PATH includes the jail's bin dir so shim symlinks take precedence
    environment:
      - PATH=/var/lib/clawrden/jailhouse/my-agent/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
      - CLAWRDEN_SOCKET=/var/run/clawrden/warden.sock

    # No network access (firewalled)
    network_mode: none

    # Keep container running for interactive access
    command: tail -f /dev/null

    depends_on:
      warden:
        condition: service_healthy

  # ─── Prisoner 2 (Alpine-based agent) ──────────────────────────────────────
  prisoner2:
    image: clawrden-alpine
    container_name: clawrden-prisoner2
    hostname: prisoner2

    volumes:
      - jailhouse-data:/var/lib/clawrden:ro
      - socket-dir:/var/run/clawrden
      - workspace:/app

    environment:
      - PATH=/var/lib/clawrden/jailhouse/python-agent/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
      - CLAWRDEN_SOCKET=/var/run/clawrden/warden.sock

    network_mode: none

    command: tail -f /dev/null

    depends_on:
      warden:
        condition: service_healthy

    # Start this container only when explicitly requested
    profiles:
      - multi-prisoner

# ─── Named Volumes ───────────────────────────────────────────────────────────
volumes:
  socket-dir:
    name: clawrden-socket
  workspace:
    name: clawrden-workspace
  jailhouse-data:
    name: clawrden-jailhouse

# ─── Networks ────────────────────────────────────────────────────────────────
networks:
  clawrden:
    name: clawrden-net
    driver: bridge
